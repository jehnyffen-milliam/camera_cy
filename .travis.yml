#language: bash
#
#sudo: required
#
#services:
#  - docker
#
#script:
#  - docker run -it -v $PWD:/e2e -w /e2e -e CYPRESS_RECORD_KEY=$CY_KEY cypress/included:3.4.0 --record --parallel --group $TESTFOLDER --ci-build-id TRAVIS_BUILD_ID
#
#env: 
#  - TESTFOLDER=integration/cameras/group_1/
#  - TESTFOLDER=integration/cameras/group_2/

sudo: false
language: node_js
node_js: "10"

#     test cypress smoke
testSmokeCy: &testSmokeCy
  script:
#  - $(npm bin)/wait-on http-get://localhost:4200/#
  - npm run cy:run:smoke -- --record --parallel --group smoke-tests
    # after all tests finish running we need
  # to kill all background jobs (like "npm start &")
  - kill $(jobs -p) || true

testPostDeploy: &testPostDeploy
  script: CYPRESS_baseUrl=$BASE_URL npm run cy:run:all -- --record --parallel --group $GROUP_NAME --ci-build-id PostDeploy-$GROUP_NAME-$TRAVIS_BUILD_ID

install:
- npm ci

jobs:
  fast_finish: true
  allow_failures:
  - name: "Cypress Applitools Snapshot tests"
  include:
  # precache npm and apt dependencies
  #    - stage: precache
  #      install: npm ci
  #      script: true
  #      addons:
  #        chrome: stable
  #        apt:
  #          sources:
  #          - ubuntu-toolchain-r-test
  #          # required by node-gyp to build some packages
  #          packages:
  #          - g++-4.8
  # run in parallel
  - stage: "Publish to ngx-bootstrap-ci"
    install: true
    script:
    - npm ci
    - npm run build
    - npm run ci:update-pkg
    - npm publish --tag $TRAVIS_COMMIT
    skip_cleanup: true
    on:
      all_branches: true
  #   test
  - script:
    name: "Cypress Smoke Tests 1t thread"
    <<: *testSmokeCy
  - script:
    name: "Cypress Smoke Tests 2d thread"
    <<: *testSmokeCy


cache:
  apt: true
  npm: true
  directories:
  - node_modules
  - ~/.npm
  - ~/.cache
